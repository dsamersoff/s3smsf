# SMS Forwarder on SDP32-wroom and SIM800Lv2 or Linux and Huawei GSM modem

### Введение

Цель проекта - создание коробочки (s3smsf-esp), которая умеет пересылать SMS с одного телефонного номера на другой. Интернет нигде не используется, и это принципиальное решение (см [Обсуждение]()).
Программная часть написана полностью с нуля на языке C и предназначена для работы или под управлением Linux или под управлением FreeRTOS.  Т.е. может быть частью комплекта состоящего из любого юниксового компьютера и USB модема, так и отдельно стоящей коробочки.

Аппаратная часть отдельно стоящей коробочки состоит из ESP32-WROOM (вариантов ESP32 много, важно наличие uart2 и питание от 5v), SIM800Lv2 (у второй версии гораздо лучше антенна и питание от 5v), ssd1306 i2c LCD  display 128x64 (экран не обязателен, служит для отображения текущего статуса).

### Измененния к предыдущему релизу
  - В аппартную часть добавлен диод, который защищает ESP32 от перегрузки оп питанию вов врмея запуска модема.
  - Выкинута плата MP102, вместо нее поставлен просто Type-C разъем
  - Реализована поддержка чтения и отправки multipart (concatenated) SMS
  - Произведен рефакторинг кода, для храненния и обработки сообщений используется heap память а не on-stack buffers, т.к. последние вызывают трудноуловимые проблемы у ESP32.


### Руководство пользователя
- Купить симкарту с тарифом с достаточным  количеством SMS, формат MINI-SIM
- Вставить симкарту в телефон и
    - отключить запрос пинкода
    - удалить все контакты с сим карты
    - добавить контакт "PRIMARY NUMBER" (с пробелом без ковычек) с тем номером телефона, на который будут пересылаться все SMS, номер указывается в международном формате (+7 321 987 65 43)
  #### Для пользователей коробочки
  - Подготовить адаптер питания, USB 5v 2A
  - Подготовить провод USB Type-C
  - Вставить симкарту в модем
  - Включить питание
  - Подождать несколько минут и убедиться что на экране написано
      - DM\S <version>
      - Название вашего GSM оператора
      - Номер телефона для переадрессации
      - Ниже бегут строчки с числом найденных сообщений
    #### Для пользователей Linux и USB модема
    - Убедиться, что модем найден например, как /dev/ttyUSB0
    - Запустить программу ./s3smsf -p <port>
    - Программа может работать в фоне с флагом `-D`
    - Номер для переадресации можно указать через `-a <номер>`
    - Команды обслуживания можно выполнять прямо из командной строки через `-c <команда>`, например: `-c "++CLEAR"`
    - Уровень подробности логов можно настроить флагом `-v` от 3 (ERROR) до 7 (DEBUG)
    - Логи можно перенаправить в файл через `-l <файл>`
    - Или в syslog через `-L`.

  SMS отправленные с PRIMARY NUMBER могут содержать команды для управления, командные SMS не пересылаются.

  Доступные команды:
- `++CLEAR` — удаляет все сообщения с SIM-карты.
- `++CONTACTS` — выводит в консоль первые 25 контактов с SIM-карты.
- `++DUMP` — выводит все сообщения с SIM-карты в консоль.
- `++DELETE <n>` — включает/отключает удаление входящих сообщений (`n` — 0 или 1).
- `++EXPIRE <n>` — включает/отключает поддержку срока действия (`n` — 0 или 1).
- `++FORWARD <n>` — включает/отключает переадресацию (`n` — 0 или 1).
- `++HEADER <n>` — включает/отключает дополнительный заголовок (`n` — 0 или 1).
- `++LOG <n>` — задаёт уровень логирования, например `++LOG 7` включает отладочный вывод.
- `++MULTIPART <n>` — включает/отключает поддержку multipart SMS (`n` — 0 или 1).
- `++SAVED` — выводит в консоль все сообщения из хеш-таблицы.

### Описание программной части
##### Компиляция
Зависимости: cmake > 3.16, esp-idf (для FreeRTOS версии)

Linux:

```
cd <project folder>
mkdir build
cd build
cmake -DTARGET=linux ..
make
```

Linux (cross)

```
cd <project folder>
mkdir build
cd build
cmake -DTARGET=linux -DCMAKE_C_COMPILER=<path to cross compiler> ..
make
```

FreeRTOS
Установите esp-idf в соответствии с документацией

```
cd <project folder>
idf.py build
idf.py flash
```

Off-line testing
```
cd <project folder>
mkdir build
cd build
cmake -DTARGET=moc
make
```

##### Структура исходников

```
components/ - дополнительные компоненты RTOS, в частности драйвер ssd1306
documents/  - документация
main/       - файлы специфичные для RTOS
main-linux/ - файлы специфичные для Linux
main-moc/   - файлы специфичные для off-line тестирования
shared/     - файлы общие для всех операционных систем
README.md
```
Основные платформозависимые вещи собраны в файле smsf-hal.c

##### Известные проблемы
SIM800Lv2 чувствителен к качеству питания и не с каждыи USB-блоком питания будет работать корректно.

### Описание аппаратной части
Основа аппаратной части микроконтроллер ESP32 и модем SIM800Lv2, модем подключен к GPIO 27 (TX модема) и GPIO 25 (RX модема), которые запрограммированы соотвественно на RX и TX UART2 микроконтроллера. Также к микроконтроллеру подключен I2C LCD screen GPIO 21 на SDA экрана и GPIO 22 на SCK экрана. Экран питается с вывода 3.3v микроконтроллера, модем требует самостоятельного питания 5v, т.к. в пиках (момент подключение к сети) модем может потреблять больше 1A, в систему установлен конденсатор 4700 mF/16v. Дополнительно установлен диод RL207, чтобы защитить ESP32 от перегрузки, вызванной модемом.

![s3smsf.png]()

### Обсуждение
1. Симкарта может хранить от 10 до 15 сообщений, если память заканчивается, можем перестает принимать сообщения. В тоже время, никакого способа обеспечить транзакцию нет - если нам удалось удалить сообщение 4, но не удалось удалить сообщение 5, то следующая попытка удалить сообщение 5 может привести к удалению только что полученного сообщения. Поэтому сообщения перечитываются поштучно в цикле, CMGL не используется.
2. WiFi и Telegram (и т.п.), с моей точки зрения, не является ни надежным ни безопасным каналом пересылки SMS. Подобные форвардеры набирают популярность, рано или поздно они станут объектом целенаправленной атаки жуликов, при этом в силу ограниченных возможностей микроконтроллера, возможности защиты и мониторинга тоже весьма ограничены.

Тем кому очень хочется пересылать сообщения через интернет, лучше сделать решение на базе RPI (к RPI можно приделать тот же SIM800L или взять другой модем), дополнить его специализированным приложением для телефона и использовать push-нотификацию, аналогично тому как это делают банковские приложения. Но такое решение выходит за рамки этого проекта.

