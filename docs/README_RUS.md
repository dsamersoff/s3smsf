# SMS Forwarder on SDP32-wroom and SIM800Lv2 or Linux and Huawei GSM modem

### Введение

Цель проекта - создание коробочки (s3smsf-esp), которая умеет пересылать SMS с одного телефонного номера на другой. Интернет нигде не используется, и это принципиальное решение (см [Обсуждение]()).
Программная часть написана полностью с нуля на языке C и предназначена для работы или под управлением Linux или под управлением FreeRTOS.  Т.е. может быть частью комплекта состоящего из любого юниксового компьютера и USB модема, так и отдельно стоящей коробочки.

Аппаратная часть отдельно стоящей коробочки состоит из ESP32-WROOM (вариантов ESP32 много, важно наличие uart2 и питание от 5v), SIM800Lv2 (у второй версии гораздо лучше антенна и питание от 5v), ssd1306 i2c LCD  display 128x64 (экран не обязателен, служит для отображения текущего статуса).

### Руководство пользователя
- Купить симкарту с тарифом с достаточным  количеством SMS, формат MINI-SIM
- Вставить симкарту в телефон и
    - отключить запрос пинкода
    - удалить все контакты с сим карты
    - добавить контакт "PRIMARY NUMBER" (с пробелом без ковычек) с тем номером телефона, на который будут пересылаться все SMS, номер указывается в международном формате (+7 321 987 65 43)
  #### Для пользователей коробочки
  - Подготовить адаптер питания, USB 5v 2A
  - Подготовить провод MINI-USB
  - Вставить симкарту в модем,
  - Включить питание
  - Подождать несколько минут и убедиться что на экране написано
      - DM\S <version>
      - Номер телефона для переадрессации
      - Название вашего GSM оператора
      - Ниже бегут строчки с числом найденных сообщений
    #### Для пользователей Linux и USB модема
    - Убедиться, что модем найден например, как /dev/ttyUSB0
    - Запустить программу ./s3smsf -p <port>
        - Программа может уйти в фон с ключом -D
        - Телефонный номер для пересылки можно указать в командной строке -a <phone>
  SMS отправленные с PRIMARY NUMBER могут содержать команды для управления, командные SMS не пересылаются.

  Доступны следующие команды:
    - ++CLEAR - удалить все сообщения с симкарты
    - ++DUMP - напечатать все сообщения с симкарты в консоль
    - ++CONTACTS - напечатать первые 25 сохраненных контактов в консоле
    - ++SAVED - напечатать все сообщения из внутренней таблицы в консоль
    - ++LOG <digit> - устанавливает уровень логирования, где 1 ничего, 3 ошибки ... 7 отладка

### Описание программной части
##### Компиляция
Зависимости: cmake > 3.16, esp-idf (для FreeRTOS версии)

Linux:

```
cd <project folder>
mkdir build
cd build
cmake -DTARGET=linux ..
make
```

Linux (cross)

```
cd <project folder>
mkdir build
cd build
cmake -DTARGET=linux -DCMAKE_C_COMPILER=<path to cross compiler> ..
make
```

FreeRTOS
Установите esp-idf в соответствии с документацией

```
cd <project folder>
idf.py build
idf.py flash
```

Off-line testing
```
cd <project folder>
mkdir build
cd build
cmake -DTARGET=moc
make
```

##### Структура исходников

```
components/ - дополнительные компоненты RTOS, в частности драйвер ssd1306
documents/  - документация
main/       - файлы специфичные для RTOS
main-linux/ - файлы специфичные для Linux
main-moc/   - файлы специфичные для off-line тестирования
shared/     - файлы общие для всех операционных систем
README.md
```
Основные платформозависимые вещи собраны в файле smsf-hal.c

##### Известные проблемы
- не поддерживается разбиение SMS на части при отправке: слишком длинные сообщения будут обрезанны; если сообщение пришло в нескольких частях, будет переслана только первая часть.
- обработка тайм штампов нуждается в доработке, век (20xx) зашит намертво и таймзона не учитывается при вычисление expire

### Описание аппаратной части
Основа аппаратной части микроконтроллер ESP32 и модем SIM800Lv2, модем подключен к GPIO 27 (TX модема) и GPIO 25 (RX модема), которые запрограммированы соотвественно на RX и TX UART2 микроконтроллера. Также к микроконтроллеру подключен I2C LCD screen GPIO 21 на SDA экрана и GPIO 22 на SCK экрана. Экран питается с вывода 3.3v микроконтроллера, модем требует самостоятельного питания 5v, т.к. в пиках (момент подключение к сети) модем может потреблять больше 1A, в систему установлен конденсатор 4700 mF/16v.

TODO: Сейчас питание подается через странную плату MB102, проверить нельзя ли просто подключить USB блок питания.

![s3smsf.png]()

### Обсуждение
1. Симкарта может хранить от 10 до 15 сообщений, если память заканчивается, можем перестает принимать сообщения. В тоже время, никакого способа обеспечить транзакцию нет - если нам удалось удалить сообщение 4, но не удалось удалить сообщение 5, то следующая попытка удалить сообщение 5 может привести к удалению только что полученного сообщения. Поэтому сообщения перечитываются поштучно в цикле, CMGL не используется.
2. WiFi и Telegram (и т.п.), с моей точки зрения, не является ни надежным ни безопасным каналом пересылки SMS. Подобные форвардеры набирают популярность, рано или поздно они станут объектом целенаправленной атаки жуликов, при этом в силу ограниченных возможностей микроконтроллера, возможности защиты и мониторинга тоже весьма ограничены.

    Тем кому очень хочется пересылать сообщения через интернет, лучше сделать решение на базе RPI (к RPI можно приделать тот же SIM800L или взять другой модем), дополнить его специализированным приложением для телефона и использовать push-нотификацию, аналогично тому как это делают банковские приложения. Но такое решение выходит за рамки этого проекта.
